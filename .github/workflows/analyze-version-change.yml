name: Analyze Version Change

on:
  workflow_dispatch:
  repository_dispatch:
    types: [analyze-connector-changes]

jobs:
  analyze:
    name: Analyze connector version changes
    runs-on: ubuntu-latest

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Install dependencies
        run: |
          sudo apt-get update
          sudo apt-get install -y jq

      - name: Set up Ballerina
        uses: ballerina-platform/setup-ballerina@v1.1.0
        with:
          version: latest

      - name: Generate git diff for client.bal and types.bal
        id: diff
        run: |
          # Generate diff between main and auto-generate-connector branches
          echo "Generating diff between origin/main and origin/auto-generate-connector..."

          # Generate diff for client.bal
          git diff origin/main..origin/auto-generate-connector -- ballerina/client.bal > client_diff.txt || true

          # Generate diff for types.bal
          git diff origin/main..origin/auto-generate-connector -- ballerina/types.bal > types_diff.txt || true

          # Combine diffs
          cat client_diff.txt types_diff.txt > git_diff.txt

          # Check if diff is not empty
          if [ ! -s git_diff.txt ]; then
            echo "No changes detected in client.bal or types.bal"
            echo "has_changes=false" >> $GITHUB_OUTPUT
            exit 0
          fi

          echo "has_changes=true" >> $GITHUB_OUTPUT
          echo "Diff generated successfully"
          echo "Client diff size: $(wc -c < client_diff.txt) bytes"
          echo "Types diff size: $(wc -c < types_diff.txt) bytes"
          echo "Combined diff size: $(wc -c < git_diff.txt) bytes"

          # Show first 100 lines of diff for debugging
          echo "--- First 100 lines of diff ---"
          head -100 git_diff.txt

      - name: Run analysis
        if: steps.diff.outputs.has_changes == 'true'
        env:
          ANTHROPIC_API_KEY: ${{ secrets.ANTHROPIC_API_KEY }}
        run: |
          # Read the diff content
          DIFF_CONTENT=$(cat git_diff.txt)

          # Run the Ballerina analysis script
          cd scripts
          bal run analyze_version_change.bal -- "$DIFF_CONTENT"
          mv analysis_result.json ../

      - name: Display results
        if: always()
        run: |
          if [ -f analysis_result.json ]; then
            echo "Analysis Results:"
            cat analysis_result.json | jq '.'
          else
            echo "No analysis result file found"
          fi

      - name: Upload analysis results
        if: steps.diff.outputs.has_changes == 'true'
        uses: actions/upload-artifact@v4
        with:
          name: version-analysis
          path: |
            analysis_result.json
            git_diff.txt
            client_diff.txt
            types_diff.txt

      - name: Comment on PR
        if: github.event_name == 'repository_dispatch' && steps.diff.outputs.has_changes == 'true'
        uses: actions/github-script@v7
        with:
          script: |
            const fs = require('fs');

            if (!fs.existsSync('analysis_result.json')) {
              console.log('No analysis result found');
              return;
            }

            const analysis = JSON.parse(fs.readFileSync('analysis_result.json', 'utf8'));

            let comment = `## ðŸ“Š Version Change Analysis\n\n`;
            comment += `**Recommended Version Bump:** \`${analysis.changeType}\`\n`;
            comment += `**Confidence:** ${analysis.confidence}\n\n`;
            comment += `### Summary\n${analysis.summary}\n\n`;

            if (analysis.breakingChanges.length > 0) {
              comment += `### âš ï¸ Breaking Changes\n`;
              analysis.breakingChanges.forEach(change => {
                comment += `- ${change}\n`;
              });
              comment += '\n';
            }

            if (analysis.newFeatures.length > 0) {
              comment += `### âœ¨ New Features\n`;
              analysis.newFeatures.forEach(feature => {
                comment += `- ${feature}\n`;
              });
              comment += '\n';
            }

            if (analysis.bugFixes.length > 0) {
              comment += `### ðŸ› Improvements\n`;
              analysis.bugFixes.forEach(fix => {
                comment += `- ${fix}\n`;
              });
            }

            const prNumber = context.payload.client_payload?.pr_number;

            if (prNumber) {
              await github.rest.issues.createComment({
                owner: context.repo.owner,
                repo: context.repo.repo,
                issue_number: prNumber,
                body: comment
              });
            }
