name: Analyze Version Change

on:
  workflow_dispatch:
  repository_dispatch:
    types: [analyze-connector-changes]

jobs:
  analyze:
    name: Analyze connector version changes
    runs-on: ubuntu-latest

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Install dependencies
        run: |
          sudo apt-get update
          sudo apt-get install -y jq

      # âš ï¸ MOVE THIS STEP UP - Set up Ballerina BEFORE using bal command
      - name: Set up Ballerina
        uses: ballerina-platform/setup-ballerina@v1.1.0
        with:
          version: latest

      - name: Sort and normalize Ballerina files
        run: |
          # Create temporary directory for sorted files
          mkdir -p /tmp/sorted_old /tmp/sorted_new

          # Checkout old version (main branch)
          git checkout origin/main

          # Sort old client.bal
          if [ -f ballerina/client.bal ]; then
            bal run scripts/sort_ballerina_client.bal -- ballerina/client.bal /tmp/sorted_old/client.bal
          fi

          # Sort old types.bal
          if [ -f ballerina/types.bal ]; then
            bal run scripts/sort_ballerina_types.bal -- ballerina/types.bal /tmp/sorted_old/types.bal
          fi

          # Checkout new version (auto-generate-connector branch)
          git checkout origin/auto-generate-connector

          # Sort new client.bal
          if [ -f ballerina/client.bal ]; then
            bal run scripts/sort_ballerina_client.bal -- ballerina/client.bal /tmp/sorted_new/client.bal
          fi

          # Sort new types.bal
          if [ -f ballerina/types.bal ]; then
            bal run scripts/sort_ballerina_types.bal -- ballerina/types.bal /tmp/sorted_new/types.bal
          fi

      - name: Generate normalized git diff
        id: diff
        run: |
          # Generate diff on sorted files
          diff -u /tmp/sorted_old/client.bal /tmp/sorted_new/client.bal > client_diff.txt || true
          diff -u /tmp/sorted_old/types.bal /tmp/sorted_new/types.bal > types_diff.txt || true

          # Combine diffs
          cat client_diff.txt types_diff.txt > git_diff.txt

          # Check if diff is not empty
          if [ ! -s git_diff.txt ]; then
            echo "No changes detected in client.bal or types.bal"
            exit 1
          fi

          echo "Diff generated successfully"
          echo "Client diff size: $(wc -c < client_diff.txt) bytes"
          echo "Types diff size: $(wc -c < types_diff.txt) bytes"
          echo "Combined diff size: $(wc -c < git_diff.txt) bytes"

      - name: Run analysis
        env:
          ANTHROPIC_API_KEY: ${{ secrets.ANTHROPIC_API_KEY }}
        run: |
          cd scripts

          # Read the diff content and pass it as an argument
          DIFF_CONTENT=$(cat ../git_diff.txt)

          # Run the Ballerina script with the diff content
          bal run analyze_version_change.bal -- "$DIFF_CONTENT"

          mv analysis_result.json ../

      - name: Display results
        if: always()
        run: |
          if [ -f analysis_result.json ]; then
            echo "Analysis Results:"
            cat analysis_result.json | jq '.'
          fi

      - name: Upload analysis results
        uses: actions/upload-artifact@v4
        with:
          name: version-analysis
          path: |
            analysis_result.json
            git_diff.txt
            client_diff.txt
            types_diff.txt

      - name: Comment on PR
        if: github.event_name == 'repository_dispatch'
        uses: actions/github-script@v7
        with:
          script: |
            const fs = require('fs');

            if (!fs.existsSync('analysis_result.json')) {
              console.log('No analysis result found');
              return;
            }

            const analysis = JSON.parse(fs.readFileSync('analysis_result.json', 'utf8'));

            let comment = `## ðŸ“Š Version Change Analysis\n\n`;
            comment += `**Recommended Version Bump:** \`${analysis.changeType}\`\n`;
            comment += `**Confidence:** ${analysis.confidence}\n\n`;
            comment += `### Summary\n${analysis.summary}\n\n`;

            if (analysis.breakingChanges.length > 0) {
              comment += `### âš ï¸ Breaking Changes\n`;
              analysis.breakingChanges.forEach(change => {
                comment += `- ${change}\n`;
              });
              comment += '\n';
            }

            if (analysis.newFeatures.length > 0) {
              comment += `### âœ¨ New Features\n`;
              analysis.newFeatures.forEach(feature => {
                comment += `- ${feature}\n`;
              });
              comment += '\n';
            }

            if (analysis.bugFixes.length > 0) {
              comment += `### ðŸ› Improvements\n`;
              analysis.bugFixes.forEach(fix => {
                comment += `- ${fix}\n`;
              });
            }

            const prNumber = context.payload.client_payload?.pr_number;

            if (prNumber) {
              await github.rest.issues.createComment({
                owner: context.repo.owner,
                repo: context.repo.repo,
                issue_number: prNumber,
                body: comment
              });
            }
